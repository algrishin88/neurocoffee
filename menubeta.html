<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Меню НейроКофейни — капучино, раф, латте, американо и AI-сгенерированный нейро-кофе. Закажите онлайн!">
    <meta property="og:title" content="Меню — НейроКофейня">
    <meta property="og:description" content="Выберите напиток из нашего меню или создайте свой уникальный нейро-кофе с помощью AI.">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ru_RU">
    <title>Меню - НейроКофейня</title>
    <link rel="icon" href="images/logo.ico.ico" type="image/x-icon">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/theme-toggle.css">

    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="menu.css">
    <script src="register-login.js"></script>
    <!-- <link href="/snowFlakes/snow.min.css" rel="stylesheet"> -->
</head>
<body>
    <!-- <script src="/snowFlakes/Snow.js"></script> -->
<!--
<script>
	const month = new Date().getMonth();
	if (month >= 10 || month <= 1) { new Snow(); }
</script>
-->
    <!-- Header -->
    <header>
        <button id="sidebarToggle">☰</button>
        <div class="nav-container">
            <div class="logo">НейроКофейня</div>
            <nav class="nav-logo">
                <ul class="nav-menu">
                    <li><a href="index.html">Главная</a></li>
                    <li><a href="menubeta.html" class="active">Меню</a></li>
                    <li><a href="services.html">О нас</a></li>
                    <li><a href="contact.html">Контакты</a></li>
                </ul>
            </nav>
            <div class="header-right">
                <div class="cart-icon-container" id="cartIconContainer" style="display: none;">
                    <button class="cart-btn" id="cartBtn">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count" id="cartCount">0</span>
                    </button>
                </div>
                <div class="auth-buttons">
                    <a href="login.html" class="btn btn-secondary">Войти</a>
                    <a href="register.html" class="btn btn-primary">Регистрация</a>
                </div>
            </div>
            <div class="sidebar">
                <div class="sidebar-brand">НейроКофейня</div>
                <ul>
                    <li><a href="index.html"><i class="fas fa-home"></i> Главная</a></li>
                    <li><a href="menubeta.html"><i class="fas fa-coffee"></i> Меню</a></li>
                    <li><a href="services.html"><i class="fas fa-info-circle"></i> О нас</a></li>
                    <li><a href="contact.html"><i class="fas fa-envelope"></i> Контакты</a></li>
                    <li><a href="profile.html"><i class="fas fa-user"></i> Профиль</a></li>
                </ul>
                <div class="sidebar-social">
                    <a href="https://t.me/+cmzsuwMsLSY3ZmZi" target="_blank" rel="noopener"><i class="fab fa-telegram"></i></a>
                    <a href="https://dzen.ru/id/65e0e96ea9bdc976e134ca84?share_to=link" target="_blank" rel="noopener"><i class="fas fa-newspaper"></i></a>
                    <a href="https://yandex.ru" target="_blank" rel="noopener"><i class="fab fa-yandex"></i></a>
                </div>
            </div>
        </div>
    </header>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h2>Корзина</h2>
            <button class="close-cart" id="closeCart">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <p>Ваша корзина пуста</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Итого:</span>
                <span class="total-price" id="totalPrice">0 ₽</span>
            </div>
            <button class="checkout-btn" id="checkoutBtn" disabled>Оформить заказ</button>
        </div>
    </div>
    <div class="cart-overlay" id="cartOverlay"></div>

    <!-- Coffee Generation Modal -->
    <div class="coffee-modal" id="coffeeModal">
        <div class="coffee-modal-content liquid-glass coffee-modal-scale">
            <div class="coffee-modal-header">
                <h2>Сгенерировать ваш нейро-кофе</h2>
                <button class="close-modal" id="closeCoffeeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="coffee-modal-body" id="coffeeModalBody">
                <div class="form-group">
                    <label for="mood">Ваше настроение</label>
                    <textarea id="mood" placeholder="Опишите ваше настроение, что вы чувствуете, какое кофе хотели бы попробовать..."></textarea>
                </div>
                <div class="form-group">
                    <label for="preferences">Предпочтения (необязательно)</label>
                    <textarea id="preferences" placeholder="Любимые вкусы, ингредиенты, крепость кофе..."></textarea>
                </div>
                <button class="generate-btn" id="generateCoffeeBtn">
                    <i class="fas fa-magic"></i> Сгенерировать рецепт
                </button>
            </div>
            <div class="coffee-result" id="coffeeResult" style="display: none;">
                <div class="result-content result-fade-in">
                    <h3 id="resultName"></h3>
                    <p id="resultDescription"></p>
                    <div class="result-details">
                        <div class="result-section">
                            <h4>Ингредиенты:</h4>
                            <p id="resultIngredients"></p>
                        </div>
                        <div class="result-section">
                            <h4>Приготовление:</h4>
                            <p id="resultInstructions"></p>
                        </div>
                        <div class="result-price">
                            <span>Цена: <strong id="resultPrice"></strong> ₽</span>
                            <span>Размер: <strong id="resultSize"></strong></span>
                        </div>
                    </div>
                    <div class="result-full-ai" id="resultFullAiSection">
                        <h4 class="toggle-full-ai" id="toggleFullAi">
                            <i class="fas fa-robot"></i> Полный ответ ИИ
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </h4>
                        <div class="result-full-text" id="resultFullText"></div>
                    </div>
                    <div class="result-actions">
                        <button class="add-generated-btn" id="addGeneratedBtn">
                            <i class="fas fa-cart-plus"></i> Добавить в корзину
                        </button>
                        <button class="generate-again-btn" id="generateAgainBtn">
                            <i class="fas fa-redo"></i> Сгенерировать ещё
                        </button>
                        <a id="shareRecipeTelegram" href="#" target="_blank" rel="noopener noreferrer" class="share-telegram-btn" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; background: #0088cc; color: #fff; border-radius: 8px; text-decoration: none; font-size: 0.95rem;">
                            <i class="fab fa-telegram"></i> Поделиться в Telegram
                        </a>
                        <button id="sendRecipeBotBtn" class="share-telegram-btn" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; background: #22c55e; color: #fff; border-radius: 8px; border: none; cursor: pointer; font-size: 0.95rem;" onclick="sendRecipeViaBot()">
                            <i class="fas fa-paper-plane"></i> Отправить бариста
                        </button>
                    </div>
                </div>
            </div>
            <div class="coffee-loading" id="coffeeLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-dots">
                    <span></span><span></span><span></span>
                </div>
                <p>Генерируем уникальный рецепт для вас...</p>
            </div>
        </div>
    </div>
    <div class="coffee-modal-overlay" id="coffeeModalOverlay"></div>

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="quick-view-modal" style="display:none;">
        <div class="quick-view-card liquid-glass">
            <button class="quick-view-close" id="quickViewClose">×</button>
            <img id="qvImage" src="" alt="">
            <div class="quick-view-info">
                <h3 id="qvName"></h3>
                <p id="qvDescription"></p>
                <div class="quick-view-sizes" id="qvSizes"></div>
                <div style="margin-top:0.8rem; display:flex; gap:0.6rem; align-items:center;">
                    <button id="qvAddToCart" class="add-to-cart-btn"><i class="fas fa-plus"></i> В корзину</button>
                    <button id="qvGenerate" class="generate-coffee-btn" style="display:none;"><i class="fas fa-magic"></i> Сгенерировать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Container -->
    <div class="menu-container">
        <div class="menu-header animated fadeIn" style="animation-duration: 0.8s;">
            <h1 class="menu-title menu-title-glow">Наше Меню</h1>
            <p class="menu-subtitle animated fadeIn" style="animation-delay: 0.2s; animation-fill-mode: both;">*меню будет обновляться</p>
        </div>

        <div class="menu-grid" id="menuGrid">
            <!-- Menu items will be generated by JavaScript -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Как связаться с нами?</h3>
                <ul>
                    <li><a href="tel:+79001234567"><i class="fas fa-phone"></i> +7 *** *** 05-70</a></li>
                    <li><a href="mailto:TishUp@yandex.ru"><i class="fas fa-envelope"></i> TishUp@yandex.ru</a></li>
                    <li><a href="requisites.html"><i class="fas fa-file-invoice"></i> Реквизиты</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Мы в соцсетях</h3>
                <ul class="social-icons">
                    <li><a href="https://t.me/+cmzsuwMsLSY3ZmZi" target="_blank" rel="noopener"><i class="fab fa-telegram"></i></a></li>
                    <li><a href="https://dzen.ru/id/65e0e96ea9bdc976e134ca84?share_to=link" target="_blank" rel="noopener"><i class="fas fa-newspaper"></i></a></li>
                    <li><a href="https://yandex.ru" target="_blank" rel="noopener"><i class="fab fa-yandex"></i></a></li>
                </ul>
            </div>
            <div class="copyright">
                <p>&copy; 2024–2026 НейроКофейня</p>
                <p class="copyright-credits">Designed by <a href="https://ssir-team.ru/" target="_blank" rel="noopener">ssir-team</a> <span class="copyright-sep">|</span> <a href="https://t.me/Tisha_sir" target="_blank" rel="noopener">Trogovitsky</a></p>
            </div>
        </div>
    </footer>

    <script src="js/theme-toggle.js"></script>
    <script src="js/api.js"></script>
    <script src="js/shared-ui.js"></script>
    <script src="js/cart.js"></script>
    <script>
        // Menu items data (fallback) with categories
        let menuItems = [
            { id: 1, name: 'Нейро-капучино', description: 'бодрящий капучино для старта работы', image: 'images/img_1.jpg', category: 'Напитки', sizes: [{ size: '200мл', price: 89 }, { size: '350мл', price: 110 }] },
            { id: 2, name: 'Квантовый раф', description: 'Почти как компьютер, только на сливках', image: 'images/img_2.jpg', category: 'Напитки', sizes: [{ size: '350мл', price: 140 }, { size: '450мл', price: 200 }] },
            { id: 3, name: 'Цифровой Латте', description: 'С ним точно ничего не забудите', image: 'images/img_3.jpg', category: 'Напитки', sizes: [{ size: '250мл', price: 110 }, { size: '350мл', price: 150 }] },
            { id: 4, name: 'Серверный американо', description: 'Крепкий, для настоящих senior', image: 'images/img_4.jpg', category: 'Напитки', sizes: [{ size: '200мл', price: 110 }, { size: '300мл', price: 130 }] },
            { id: 5, name: 'Ваш нейро-кофе', description: 'Сгенерируйте свой нейро-кофе дня', image: 'images/img_5.jpg', category: 'Напитки', sizes: [{ size: '200мл-450мл', price: 80 }, { size: '200мл-450мл', price: 350 }] },
            { id: 6, name: 'Матча ревью', description: 'Для тех, у кого сегодня код-ревью', image: 'images/img_6.jpg', category: 'Напитки', sizes: [{ size: '250мл', price: 200 }, { size: '350мл', price: 250 }] },
            { id: 7, name: 'Круассан', description: 'Свежая выпечка', image: 'images/img_7.jpg', category: 'Гарниры', sizes: [{ size: '1 шт', price: 120 }] },
            { id: 8, name: 'Печенье с шоколадом', description: 'Домашнее печенье', image: 'images/img_8.jpg', category: 'Гарниры', sizes: [{ size: '1 шт', price: 50 }] },
            { id: 9, name: 'Морковный кекс', description: 'Нежный десерт', image: 'images/img_9.jpg', category: 'Десерты', sizes: [{ size: 'порция', price: 160 }] },
            { id: 10, name: 'Айс-латте', description: 'Освежающий холодный латте со льдом', image: 'images/img_10.jpg', category: 'Напитки', sizes: [{ size: '250мл', price: 150 }, { size: '400мл', price: 190 }] },
            { id: 11, name: 'Cold Brew', description: 'Долгозаваренный холодный кофе', image: 'images/img_11.jpg', category: 'Напитки', sizes: [{ size: '300мл', price: 180 }] },
            { id: 12, name: 'Раф карамель', description: 'Кремовый раф с карамельной ноткой', image: 'images/img_12.jpg', category: 'Напитки', sizes: [{ size: '350мл', price: 170 },{ size: '450мл', price: 270 }] },
            { id: 13, name: 'Сэндвич с курицей', description: 'Тёплый сэндвич с маринованной курицей и овощами', image: 'images/img_13.jpg', category: 'Гарниры', sizes: [{ size: '1 шт', price: 220 }] },
            { id: 14, name: 'Сэндвич вегетарианский', description: 'Сэндвич с авокадо, хумусом и ростками', image: 'images/img_14.jpg', category: 'Гарниры', sizes: [{ size: '1 шт', price: 200 }] },
            { id: 15, name: 'Банановый маффин', description: 'Пышный маффин с бананом и орехами', image: 'images/img_15.jpg', category: 'Десерты', sizes: [{ size: '1 шт', price: 120 }] },
            { id: 16, name: 'Брауни шоколадный', description: 'Насыщенный шоколадный брауни', image: 'images/img_16.jpg', category: 'Десерты', sizes: [{ size: 'порция', price: 150 }] },
            { id: 17, name: 'Йогурт с гранолой', description: 'Лёгкий завтрак с йогуртом и хрустящей гранолой', image: 'images/img_17.jpg', category: 'Завтраки', sizes: [{ size: 'порция', price: 140 }] },
            { id: 18, name: 'Протеиновый коктейль', description: 'Белковый буст после тренеровки', image: 'images/img_18.jpg', category: 'Напитки', sizes: [{ size: '200мл', price: 150 },{ size: '500мл', price: 350 }] }
        ];

        async function loadMenuFromAPI() {
            try {
                const response = await fetch('/api/menu');
                const data = await response.json();
                if (data.success && data.menuItems && data.menuItems.length > 0) {
                    menuItems = data.menuItems.map(item => ({
                        id: item.itemId,
                        name: item.name,
                        description: item.description,
                        image: item.image,
                        sizes: item.sizes.map(s => ({ size: s.size, price: s.price })),
                        category: item.category || item.categoryName || 'Напитки'
                    }));
                }
            } catch (e) {
                console.warn('Failed to load menu from API, using fallback data');
            }
            renderCategories();
            renderMenuItems();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Load menu from API (or use fallback) and render
            loadMenuFromAPI();
            
            // Wait for cart manager to initialize
            setTimeout(() => {
                if (window.cartManager) {
                    window.cartManager.updateCartUI();
                }
            }, 100);
        });

        let activeCategory = 'Все';

        function renderCategories() {
            const container = document.querySelector('.menu-container');
            if (!container) return;
            const categories = ['Все', ...Array.from(new Set(menuItems.map(i=>i.category || 'Напитки'))).sort()];
            const existing = document.getElementById('categoryBar');
            if (existing) existing.remove();
            const bar = document.createElement('div');
            bar.id = 'categoryBar';
            bar.className = 'category-bar';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-button' + (cat===activeCategory ? ' active' : '');
                btn.textContent = cat;
                btn.addEventListener('click', () => { activeCategory = cat; document.querySelectorAll('.category-button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderMenuItems(); });
                bar.appendChild(btn);
            });
            container.insertBefore(bar, container.querySelector('.menu-grid'));
        }

        function renderMenuItems() {
            const menuGrid = document.getElementById('menuGrid');
            if (!menuGrid) return;

            const itemsToRender = activeCategory === 'Все' ? menuItems : menuItems.filter(it => (it.category||'').toLowerCase() === activeCategory.toLowerCase());

            menuGrid.innerHTML = itemsToRender.map((item, i) => `
                <div class="menu-item liquid-glass menu-item-reveal" style="animation-delay: ${0.05 * (i + 1)}s" data-id="${item.id}">
                    <div class="menu-item-image">
                        <img src="${item.image}" alt="${item.name}" loading="lazy">
                    </div>
                    <div class="menu-item-content">
                        <h3 class="menu-item-name">${item.name}</h3>
                        <p class="menu-item-description">${item.description}</p>
                        <div class="menu-item-sizes" id="sizes-${item.id}">
                            ${item.sizes.map((size, index) => `
                                <div class="size-option ${index === 0 ? 'selected' : ''}" 
                                     data-size="${size.size}" 
                                     data-price="${size.price}"
                                     onclick="selectSize(${item.id}, '${size.size}', ${size.price})">
                                    <span class="size-label">${size.size}</span>
                                    <span class="size-price">${size.price}₽</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="display:flex; gap:0.5rem; margin-top:0.6rem;">
                            ${item.id === 5 ? `
                                <button class="generate-coffee-btn" onclick="openCoffeeGenerator(${item.id}, '${item.name.replace(/'/g, "\\'")}', '${item.image}')">
                                    <i class="fas fa-magic"></i> Сгенерировать
                                </button>
                            ` : `
                                <button class="add-to-cart-btn" onclick="addToCart(${item.id}, '${item.name.replace(/'/g, "\\'")}', '${item.image}')">
                                    <i class="fas fa-plus"></i> В корзину
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getItemById(id){ return menuItems.find(i=>i.id==id) || null; }

        function openQuickView(itemId){
            const item = getItemById(itemId);
            if (!item) return;
            document.getElementById('qvImage').src = item.image;
            document.getElementById('qvName').textContent = item.name;
            document.getElementById('qvDescription').textContent = item.description || '';
            const sizesEl = document.getElementById('qvSizes'); sizesEl.innerHTML = '';
            item.sizes.forEach((s, idx)=>{
                const el = document.createElement('div'); el.className = 'size-option ' + (idx===0?'selected':''); el.dataset.size=s.size; el.dataset.price=s.price; el.innerHTML = `<span class="size-label">${s.size}</span> <span class="size-price">${s.price}₽</span>`;
                el.addEventListener('click', ()=>{ document.querySelectorAll('#qvSizes .size-option').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); });
                sizesEl.appendChild(el);
            });
            // configure buttons
            const addBtn = document.getElementById('qvAddToCart');
            addBtn.onclick = ()=>{
                const sel = sizesEl.querySelector('.size-option.selected');
                const price = sel ? parseInt(sel.dataset.price) : (item.sizes[0] && item.sizes[0].price) || 0;
                if (window.cartManager) {
                    window.cartManager.addItem({ id: item.id, name: item.name, price: price, size: sel ? sel.dataset.size : (item.sizes[0] && item.sizes[0].size), image: item.image, quantity: 1 });
                    document.getElementById('quickViewModal').style.display = 'none';
                } else {
                    showToast('Корзина не доступна', 'warning');
                }
            };
            const genBtn = document.getElementById('qvGenerate');
            if (item.id === 5) { genBtn.style.display='inline-flex'; genBtn.onclick = ()=> openCoffeeGenerator(item.id, item.name, item.image); }
            else genBtn.style.display='none';

            document.getElementById('quickViewModal').style.display = 'flex';
        }

        function closeQuickView(){ document.getElementById('quickViewModal').style.display = 'none'; }

        function selectSize(itemId, size, price) {
            const sizeOptions = document.querySelectorAll(`#sizes-${itemId} .size-option`);
            sizeOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.size === size) {
                    option.classList.add('selected');
                }
            });
        }

        function getSelectedSize(itemId) {
            const selectedOption = document.querySelector(`#sizes-${itemId} .size-option.selected`);
            if (selectedOption) {
                return {
                    size: selectedOption.dataset.size,
                    price: parseInt(selectedOption.dataset.price)
                };
            }
            return null;
        }

        let currentGeneratingItem = null;

        function openCoffeeGenerator(itemId, name, image) {
            const currentUser = JSON.parse(localStorage.getItem('neuro-cafe-current-user') || sessionStorage.getItem('neuro-cafe-current-user') || 'null');
            
            if (!currentUser || currentUser === 'null') {
                showToast('Пожалуйста, войдите в аккаунт, чтобы сгенерировать кофе', 'warning');
                window.location.href = 'login.html';
                return;
            }

            currentGeneratingItem = { itemId, name, image };
            document.getElementById('coffeeModal').style.display = 'flex';
            document.getElementById('coffeeModalOverlay').style.display = 'block';
            document.getElementById('coffeeModalBody').style.display = 'block';
            document.getElementById('coffeeResult').style.display = 'none';
            document.getElementById('coffeeLoading').style.display = 'none';
            document.getElementById('mood').value = '';
            document.getElementById('preferences').value = '';
            document.getElementById('generateCoffeeBtn').disabled = false;
        }

        function closeCoffeeModal() {
            document.getElementById('coffeeModal').style.display = 'none';
            document.getElementById('coffeeModalOverlay').style.display = 'none';
            currentGeneratingItem = null;
        }

        function backToForm() {
            document.getElementById('coffeeResult').style.display = 'none';
            document.getElementById('coffeeModalBody').style.display = 'block';
            document.getElementById('coffeeLoading').style.display = 'none';
            document.getElementById('mood').value = '';
            document.getElementById('preferences').value = '';
            document.getElementById('generateCoffeeBtn').disabled = false;
            const fullSection = document.getElementById('resultFullAiSection');
            if (fullSection) fullSection.classList.remove('expanded');
        }

        async function generateCoffee() {
            const mood = document.getElementById('mood').value.trim();
            const preferences = document.getElementById('preferences').value.trim();

            if (!mood && !preferences) {
                showToast('Пожалуйста, опишите ваше настроение или предпочтения', 'warning');
                return;
            }

            const loadingEl = document.getElementById('coffeeLoading');
            const resultEl = document.getElementById('coffeeResult');
            const formEl = document.getElementById('coffeeModalBody');
            const generateBtn = document.getElementById('generateCoffeeBtn');

            formEl.style.display = 'none';
            resultEl.style.display = 'none';
            loadingEl.style.display = 'flex';
            generateBtn.disabled = true;

            try {
                const response = await window.API.ai.generateCoffee(mood, preferences);
                
                if (response.success && response.recipe) {
                    const recipe = response.recipe;
                    const rawText = response.rawResponse || recipe.fullText || '';

                    document.getElementById('resultName').textContent = recipe.name || 'Нейро-кофе';
                    document.getElementById('resultDescription').textContent = recipe.description || '';
                    document.getElementById('resultIngredients').textContent = recipe.ingredients || '—';
                    document.getElementById('resultInstructions').textContent = recipe.instructions || '—';
                    document.getElementById('resultPrice').textContent = recipe.price ?? 200;
                    document.getElementById('resultSize').textContent = recipe.size || '350мл';
                    document.getElementById('resultFullText').textContent = rawText || 'Ответ ИИ недоступен.';
                    document.getElementById('resultFullAiSection').classList.remove('expanded');

                    window.generatedRecipe = {
                        ...recipe,
                        itemId: currentGeneratingItem.itemId,
                        image: currentGeneratingItem.image,
                        fullText: rawText,
                        mood: mood,
                        preferences: preferences
                    };
                    localStorage.setItem('neuro-cafe-generated-recipe', JSON.stringify(window.generatedRecipe));

                    var shareText = (recipe.name || 'Нейро-кофе') + '\n\n' + (recipe.description || '') + '\n\nИнгредиенты:\n' + (recipe.ingredients || '') + '\n\nПриготовление:\n' + (recipe.instructions || '');
                    var shareEl = document.getElementById('shareRecipeTelegram');
                    if (shareEl) shareEl.href = 'https://t.me/share/url?text=' + encodeURIComponent(shareText);

                    loadingEl.style.display = 'none';
                    formEl.style.display = 'none';
                    resultEl.style.display = 'block';
                } else {
                    throw new Error(response.message || 'Не удалось сгенерировать рецепт');
                }
            } catch (error) {
                console.error('Generation error:', error);
                showToast('Ошибка при генерации рецепта. ' + (error.message || 'Попробуйте еще раз.'), 'error');
                formEl.style.display = 'block';
                resultEl.style.display = 'none';
            } finally {
                loadingEl.style.display = 'none';
                generateBtn.disabled = false;
            }
        }

        function addGeneratedToCart() {
            if (!window.generatedRecipe) {
                showToast('Сначала сгенерируйте рецепт', 'warning');
                return;
            }

            if (window.cartManager) {
                window.cartManager.addItem({
                    itemId: window.generatedRecipe.itemId,
                    name: window.generatedRecipe.name,
                    price: window.generatedRecipe.price,
                    size: window.generatedRecipe.size || '350мл',
                    image: window.generatedRecipe.image,
                    quantity: 1
                });

                closeCoffeeModal();
            }
        }

        function addToCart(itemId, name, image) {
            // Check if user is logged in
            const currentUser = JSON.parse(localStorage.getItem('neuro-cafe-current-user') || sessionStorage.getItem('neuro-cafe-current-user') || 'null');
            
            if (!currentUser || currentUser === 'null') {
                showToast('Пожалуйста, войдите в аккаунт, чтобы добавить товар в корзину', 'warning');
                window.location.href = 'login.html';
                return;
            }

            const selectedSize = getSelectedSize(itemId);
            if (!selectedSize) {
                showToast('Пожалуйста, выберите размер', 'warning');
                return;
            }

            if (window.cartManager) {
                window.cartManager.addItem({
                    id: itemId,
                    name: name,
                    price: selectedSize.price,
                    size: selectedSize.size,
                    image: image,
                    quantity: 1
                });
            }
        }

        // Modal event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('closeCoffeeModal').addEventListener('click', closeCoffeeModal);
            document.getElementById('coffeeModalOverlay').addEventListener('click', closeCoffeeModal);
            document.getElementById('generateCoffeeBtn').addEventListener('click', generateCoffee);
            document.getElementById('addGeneratedBtn').addEventListener('click', addGeneratedToCart);
            document.getElementById('generateAgainBtn').addEventListener('click', backToForm);
            document.getElementById('toggleFullAi').addEventListener('click', function() {
                document.getElementById('resultFullAiSection').classList.toggle('expanded');
            });
            // quick view close
            const qvClose = document.getElementById('quickViewClose'); if (qvClose) qvClose.addEventListener('click', closeQuickView);
            document.getElementById('quickViewModal').addEventListener('click', function(e){ if(e.target===this) closeQuickView(); });
        });
    </script>
    <script>
    async function sendRecipeViaBot() {
        const btn = document.getElementById('sendRecipeBotBtn');
        if (!window.generatedRecipe || !window.API) { showToast('Сначала сгенерируйте рецепт', 'warning'); return; }
        btn.textContent = 'Отправка...';
        btn.disabled = true;
        try {
            const res = await window.API.ai.sendRecipeToTelegram(window.generatedRecipe);
            if (res.sent) {
                btn.innerHTML = '<i class="fas fa-check"></i> Отправлено!';
                btn.style.background = '#16a34a';
            } else {
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Бот не настроен';
                btn.style.background = '#f59e0b';
            }
        } catch (e) {
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Отправить бариста';
            showToast(e.message || 'Ошибка отправки', 'error');
        }
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Отправить бариста';
            btn.style.background = '#22c55e';
            btn.disabled = false;
        }, 3000);
    }
    </script>
    <script src="js/chat-widget.js"></script>
</body>
</html>

