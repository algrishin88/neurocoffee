# Админ-панель НейроКофейни

## Как зайти в админ-панель

1. **Зарегистрируйтесь или войдите** на сайте (обычный вход: [login.html](login.html)).
2. **Откройте страницу админки** по адресу:
   - Локально: `http://localhost:3307/admin.html`
   - На сайте: `https://neurocup.ru/admin.html`
3. Если у вашего пользователя роль **admin**, откроется дашборд.  
   Если роль **user** — появится сообщение «Недостаточно прав» и редирект в профиль.

---

## Как назначить первого администратора

У всех новых пользователей по умолчанию роль `user`. Первого админа нужно выдать вручную.

### Способ 1: скрипт (рекомендуется)

Из корня проекта (где есть `package.json` и папка `lib`):

```bash
node scripts/set-admin.js ваш@email.ru
```

Пример:

```bash
node scripts/set-admin.js admin@neurocup.ru
```

После этого войдите на сайте под этим email и откройте [admin.html](admin.html).

### Способ 2: через базу данных

Выполните в PostgreSQL (подставьте нужный email):

```sql
UPDATE "users" SET "role" = 'admin', "updatedAt" = NOW() WHERE LOWER("email") = LOWER('ваш@email.ru');
```

---

## Как назначать админов из админ-панели

1. Зайдите в админ-панель под учёткой с ролью **admin**.
2. В боковом меню выберите **«Пользователи»**.
3. В таблице пользователей в колонке **«Роль»** у каждого пользователя есть выпадающий список: **user** / **admin**.
4. Выберите **admin** и сохраните (изменение применяется сразу).

Технически это запрос `PATCH /api/admin/users/:id` с телом `{ "role": "admin" }` (или `"user"` для снятия прав).

---

## Как это реализовано в коде

### Проверка прав

- **Маршруты** админки висят под префиксом `/api/admin/*` в [server.js](server.js).
- Все эти маршруты проходят через **middleware** [middleware/admin.js](middleware/admin.js):
  - читает JWT из заголовка `Authorization`;
  - проверяет, что пользователь есть в БД и у него `role === 'admin'`;
  - если токена нет или роль не admin — возвращает 401 или 403.

### Роль в БД

- В таблице **users** есть поле **role** (`TEXT`, по умолчанию `'user'`).
- Допустимые значения: `'user'`, `'admin'`.
- Схема создаётся в [server.js](server.js) при старте (CREATE TABLE / миграции).

### Назначение админа через API

- В [routes/admin.js](routes/admin.js) есть `PATCH /users/:id`.
- Тело запроса: `{ "role": "admin" }` или `{ "role": "user" }`.
- Доступно только пользователям с ролью admin (потому что весь router защищён middleware).

### Страница админки

- [admin.html](admin.html) — одностраничный интерфейс: дашборд, заказы, меню, пользователи, брони, контакты, рассылка.
- При загрузке вызывается `GET /api/admin/dashboard` с токеном из `localStorage`/`sessionStorage`.
- При 401 — редирект на [login.html](login.html), при 403 — сообщение и редирект в [profile.html](profile.html).

### Скрипт первого админа

- [scripts/set-admin.js](scripts/set-admin.js) обновляет в БД поле `role` на `'admin'` у пользователя с указанным email (аргумент командной строки).
